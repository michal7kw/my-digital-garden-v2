---
layout: layouts/index.njk
title: Medical Knowledge Garden
eleventyExcludeFromCollections: true
---

{# â”€â”€ Graph Script (must be before Alpine x-init references) â”€â”€ #}
<script>
  // Initialize homepage dashboard â€” called from Alpine x-init
  async function homeInit(state, nextTick) {
    var gd = await fetch('/graph.json').then(function(r) { return r.json(); });
    state.graphData = gd;

    // Filter hidden nodes
    var hiddens = Object.values(gd.nodes).filter(function(n) { return n.hide; }).map(function(n) { return n.id; });
    var nodes = Object.values(gd.nodes).filter(function(n) { return !n.hide; });
    var links = gd.links.filter(function(l) { return hiddens.indexOf(l.source) === -1 && hiddens.indexOf(l.target) === -1; });

    state.nodeCount = nodes.length;
    state.linkCount = links.length;

    // Count by entity type
    var counts = {};
    nodes.forEach(function(n) {
      var t = (n.group || n.entityType || n.type || 'other').toLowerCase();
      counts[t] = (counts[t] || 0) + 1;
    });
    state.typeCounts = counts;

    // Sample up to 50 densely-connected, type-diverse nodes for homepage preview
    var MAX_HOME_NODES = 50;
    var previewNodes, previewLinks;
    if (nodes.length <= MAX_HOME_NODES) {
      previewNodes = nodes;
      previewLinks = links;
    } else {
      // Build adjacency map
      var adj = {};
      var nodeById = {};
      nodes.forEach(function(n) { adj[n.id] = []; nodeById[n.id] = n; });
      links.forEach(function(l) {
        var sid = typeof l.source === 'object' ? l.source.id : l.source;
        var tid = typeof l.target === 'object' ? l.target.id : l.target;
        if (adj[sid]) adj[sid].push(tid);
        if (adj[tid]) adj[tid].push(sid);
      });

      // Seed: one high-degree node per entity type
      var byType = {};
      nodes.forEach(function(n) {
        var t = (n.group || n.entityType || n.type || 'other').toLowerCase();
        if (!byType[t]) byType[t] = [];
        byType[t].push(n);
      });
      var pickedSet = new Set();
      var pickedList = [];
      Object.keys(byType).forEach(function(t) {
        byType[t].sort(function(a, b) { return (adj[b.id].length) - (adj[a.id].length); });
        var seed = byType[t][0];
        if (seed && !pickedSet.has(seed.id)) {
          pickedSet.add(seed.id);
          pickedList.push(seed);
        }
      });

      // Greedy expand: always pick the candidate with most links to picked set
      while (pickedList.length < MAX_HOME_NODES) {
        var bestNode = null;
        var bestScore = 0;
        var candidates = new Set();
        pickedList.forEach(function(n) {
          adj[n.id].forEach(function(nid) {
            if (!pickedSet.has(nid) && nodeById[nid]) candidates.add(nid);
          });
        });
        candidates.forEach(function(cid) {
          var score = 0;
          adj[cid].forEach(function(nid) { if (pickedSet.has(nid)) score++; });
          if (score > bestScore) { bestScore = score; bestNode = nodeById[cid]; }
        });
        if (!bestNode) break;
        pickedSet.add(bestNode.id);
        pickedList.push(bestNode);
      }

      previewNodes = pickedList;
      previewLinks = links.filter(function(l) {
        var sid = typeof l.source === 'object' ? l.source.id : l.source;
        var tid = typeof l.target === 'object' ? l.target.id : l.target;
        return pickedSet.has(sid) && pickedSet.has(tid);
      });
    }
    state.fullGraphData = { nodes: previewNodes, links: previewLinks };
    state.loading = false;

    // Render graph after DOM update
    nextTick(function() {
      if (state.fullGraphData && typeof ForceGraph !== 'undefined') {
        state.graphInstance = homeRenderGraph(state.fullGraphData);
      } else {
        // ForceGraph may load async â€” retry
        var iv = setInterval(function() {
          if (typeof ForceGraph !== 'undefined') {
            clearInterval(iv);
            state.graphInstance = homeRenderGraph(state.fullGraphData);
          }
        }, 200);
        setTimeout(function() { clearInterval(iv); }, 10000);
      }
    });
  }

  // Entity type colors matching graphScript.njk and _entity-types.scss
  var homeEntityTypeColors = {
    biomarker: '#4CAF50',
    drug: '#2196F3',
    supplement: '#9C27B0',
    condition: '#FF9800',
    intervention: '#00BCD4',
    hormone: '#E91E63',
    organ: '#795548',
    protein: '#3F51B5',
    metabolite: '#607D8B',
    gene: '#8BC34A',
    neurotransmitter: '#FF5722',
    cellularcomponent: '#009688',
    'default': '#888888'
  };

  function homeGetEntityColor(node) {
    var t = (node.group || node.entityType || node.type || 'default').toLowerCase();
    return homeEntityTypeColors[t] || homeEntityTypeColors['default'];
  }

  function htmlDecodeHome(input) {
    var doc = new DOMParser().parseFromString(input, "text/html");
    return doc.documentElement.textContent;
  }

  function getCssVarHome(variable) {
    return getComputedStyle(document.body).getPropertyValue(variable);
  }

  function homeRenderGraph(graphData) {
    if (!graphData) return null;
    var el = document.getElementById('home-graph-container');
    if (!el) return null;

    var width = el.offsetWidth;
    var height = el.offsetHeight;
    var highlightNodes = new Set();
    var hoverNode = null;
    var color = getCssVarHome('--graph-main') || '#d4d4d4';
    var mutedColor = getCssVarHome('--graph-muted') || '#555555';

    var Graph = ForceGraph()(el)
      .graphData(graphData)
      .nodeId('id')
      .nodeLabel('title')
      .linkSource('source')
      .linkTarget('target')
      .d3AlphaDecay(0.10)
      .width(width)
      .height(height)
      .linkDirectionalArrowLength(2)
      .linkDirectionalArrowRelPos(0.5)
      .autoPauseRedraw(false)
      .linkColor(function(link) {
        if (!hoverNode) return color;
        return (link.source.id === hoverNode.id || link.target.id === hoverNode.id) ? color : mutedColor;
      })
      .nodeCanvasObject(function(node, ctx) {
        var neighbours = (node.neighbors && node.neighbors.length) || 2;
        var nodeR = Math.min(7, Math.max(neighbours / 2, 2));
        var nodeColor = homeGetEntityColor(node);

        ctx.beginPath();
        ctx.arc(node.x, node.y, nodeR, 0, 2 * Math.PI, false);
        if (!hoverNode) {
          ctx.fillStyle = nodeColor;
        } else {
          ctx.fillStyle = (node === hoverNode || highlightNodes.has(node.url)) ? nodeColor : mutedColor;
        }
        ctx.fill();

        // Label
        var label = htmlDecodeHome(node.title);
        ctx.font = '3.5px Sans-Serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillStyle = color;
        ctx.fillText(label, node.x, node.y + nodeR + 2);
      })
      .onNodeClick(function(node) {
        window.location = node.url;
      })
      .onNodeHover(function(node) {
        highlightNodes.clear();
        if (node) {
          highlightNodes.add(node);
          if (node.neighbors) {
            node.neighbors.forEach(function(n) { highlightNodes.add(n); });
          }
        }
        hoverNode = node || null;
      });

    // Zoom to fit after layout settles
    if (graphData.nodes.length > 2) {
      setTimeout(function() { Graph.zoomToFit(400, 50); }, 500);
    }

    // Handle window resize
    var resizeObserver = new ResizeObserver(function() {
      Graph.width(el.offsetWidth).height(el.offsetHeight);
    });
    resizeObserver.observe(el);

    return Graph;
  }
</script>

<div class="home-dashboard"
     x-data="{
       graphData: null,
       fullGraphData: null,
       graphInstance: null,
       nodeCount: 0,
       linkCount: 0,
       typeCounts: {},
       loading: true,
       showLegend: true
     }"
     x-init="homeInit($data, $nextTick)">

  {# â”€â”€ Compact Header â”€â”€ #}
  <header class="home-header">
    <div class="home-header-left">
      <h1>Medical Knowledge Garden</h1>
      <p class="home-subtitle">Explore biomarkers, drugs, supplements, and health insights</p>
    </div>
    <div class="home-header-right">
      <a href="/search/" class="home-header-link">Search</a>
      <a href="/graph/" class="home-header-link">Full Graph</a>
    </div>
  </header>

  {# â”€â”€ Entity Stat Chips â”€â”€ #}
  <section class="home-stats">
    <div class="stat-chip total">
      <span class="stat-count" x-text="nodeCount">...</span>
      <span class="stat-label">Total</span>
    </div>
    <a href="/entities/biomarker/" class="stat-chip" style="--chip-color: #4CAF50;">
      <span class="stat-icon">ğŸ“Š</span>
      <span class="stat-count" x-text="typeCounts.biomarker || 0">0</span>
      <span class="stat-label">Biomarkers</span>
    </a>
    <a href="/entities/drug/" class="stat-chip" style="--chip-color: #2196F3;">
      <span class="stat-icon">ğŸ’Š</span>
      <span class="stat-count" x-text="typeCounts.drug || 0">0</span>
      <span class="stat-label">Drugs</span>
    </a>
    <a href="/entities/supplement/" class="stat-chip" style="--chip-color: #9C27B0;">
      <span class="stat-icon">ğŸŒ¿</span>
      <span class="stat-count" x-text="typeCounts.supplement || 0">0</span>
      <span class="stat-label">Supplements</span>
    </a>
    <a href="/entities/condition/" class="stat-chip" style="--chip-color: #FF9800;">
      <span class="stat-icon">ğŸ¥</span>
      <span class="stat-count" x-text="typeCounts.condition || 0">0</span>
      <span class="stat-label">Conditions</span>
    </a>
    <a href="/entities/intervention/" class="stat-chip" style="--chip-color: #00BCD4;">
      <span class="stat-icon">âš¡</span>
      <span class="stat-count" x-text="typeCounts.intervention || 0">0</span>
      <span class="stat-label">Interventions</span>
    </a>
    <a href="/entities/protein/" class="stat-chip" style="--chip-color: #3F51B5;">
      <span class="stat-icon">ğŸ§¬</span>
      <span class="stat-count" x-text="typeCounts.protein || 0">0</span>
      <span class="stat-label">Proteins</span>
    </a>
    <a href="/entities/hormone/" class="stat-chip" style="--chip-color: #E91E63;">
      <span class="stat-icon">ğŸ§¬</span>
      <span class="stat-count" x-text="typeCounts.hormone || 0">0</span>
      <span class="stat-label">Hormones</span>
    </a>
  </section>

  {# â”€â”€ Knowledge Graph â”€â”€ #}
  <section class="home-graph-section">
    {# Loading state #}
    <div class="home-graph-loading" x-show="loading" x-cloak>
      <div class="loading-spinner"></div>
      <span>Loading knowledge graph...</span>
    </div>

    {# Graph container #}
    <div class="home-graph" x-show="!loading" x-cloak>
      <div id="home-graph-container"></div>

      {# Legend overlay #}
      <div class="home-legend" x-show="showLegend" x-transition>
        <div class="home-legend-header">
          <span>Entity Types</span>
          <button class="home-legend-close" x-on:click="showLegend = false">&times;</button>
        </div>
        <div class="home-legend-items">
          <div class="home-legend-item"><span class="legend-dot" style="background: #4CAF50;"></span> Biomarker</div>
          <div class="home-legend-item"><span class="legend-dot" style="background: #2196F3;"></span> Drug</div>
          <div class="home-legend-item"><span class="legend-dot" style="background: #9C27B0;"></span> Supplement</div>
          <div class="home-legend-item"><span class="legend-dot" style="background: #FF9800;"></span> Condition</div>
          <div class="home-legend-item"><span class="legend-dot" style="background: #00BCD4;"></span> Intervention</div>
          <div class="home-legend-item"><span class="legend-dot" style="background: #E91E63;"></span> Hormone</div>
          <div class="home-legend-item"><span class="legend-dot" style="background: #3F51B5;"></span> Protein</div>
          <div class="home-legend-item"><span class="legend-dot" style="background: #888888;"></span> Other</div>
        </div>
      </div>
    </div>

    {# Graph info bar #}
    <div class="home-graph-info" x-show="!loading" x-cloak>
      <span class="graph-info-text">
        <strong x-text="nodeCount">0</strong> nodes &middot;
        <strong x-text="linkCount">0</strong> connections
      </span>
      <button class="home-legend-toggle" x-on:click="showLegend = !showLegend">
        <template x-if="showLegend">
          <span>Hide Legend</span>
        </template>
        <template x-if="!showLegend">
          <span>Show Legend</span>
        </template>
      </button>
    </div>
  </section>

  {# â”€â”€ Browse by Category â”€â”€ #}
  <section class="home-categories">
    <h2>Browse by Category</h2>
    <div class="home-categories-grid">
      <a href="/entities/biomarker/" class="home-cat-card biomarker">
        <span class="cat-icon">ğŸ“Š</span>
        <div class="cat-content">
          <span class="cat-label">Biomarkers</span>
          <span class="cat-desc">Lab values and health indicators</span>
        </div>
      </a>
      <a href="/entities/drug/" class="home-cat-card drug">
        <span class="cat-icon">ğŸ’Š</span>
        <div class="cat-content">
          <span class="cat-label">Drugs</span>
          <span class="cat-desc">Pharmaceutical compounds</span>
        </div>
      </a>
      <a href="/entities/supplement/" class="home-cat-card supplement">
        <span class="cat-icon">ğŸŒ¿</span>
        <div class="cat-content">
          <span class="cat-label">Supplements</span>
          <span class="cat-desc">Vitamins, minerals, and nutraceuticals</span>
        </div>
      </a>
      <a href="/entities/condition/" class="home-cat-card condition">
        <span class="cat-icon">ğŸ¥</span>
        <div class="cat-content">
          <span class="cat-label">Conditions</span>
          <span class="cat-desc">Diseases and health conditions</span>
        </div>
      </a>
      <a href="/entities/intervention/" class="home-cat-card intervention">
        <span class="cat-icon">âš¡</span>
        <div class="cat-content">
          <span class="cat-label">Interventions</span>
          <span class="cat-desc">Treatments and lifestyle changes</span>
        </div>
      </a>
      <a href="/entities/protein/" class="home-cat-card protein">
        <span class="cat-icon">ğŸ§¬</span>
        <div class="cat-content">
          <span class="cat-label">Proteins</span>
          <span class="cat-desc">Enzymes, receptors, and signaling molecules</span>
        </div>
      </a>
    </div>
  </section>

  {# â”€â”€ Footer â”€â”€ #}
  <footer class="home-footer-minimal">
    <p>Medical Knowledge Garden &middot; Explore. Understand. Optimize.</p>
  </footer>
</div>
